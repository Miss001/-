
# 基本架构
多节点单进程软件（一个 observer 进程）集群     
采用无共享（Shared-Nothing）分布式集群架构     
存储引擎基于 LSM-Tree 架构，支持行存储和列存储    

# 逻辑架构
- 租户       
  默认集群会生成一个系统租户（sys），用于管理和维护`OceanBase`集群。       
  每个创建的普通租户拥有独立的资源，独立的数据库、表和用户、权限，相当于一个独立的数据库实例。         
  不同租户的数据不会共享。     
- 用户     
  用户必须创建在某个租户内，无法跨租户访问        
  新建一个普通租户默认创建最高权限管理用户（root）       
  一个租户下可以创建多个用户，根据权限分配共享租户下的数据库    
- 数据库     
  数据库必须创建在某个租户内，无法跨租户访问          
  数据库与数据库之间可直接进行跨库关联查询     
  新建一个普通租户默认创建information_schema/mysql/oceanbase/test数据库（MYSQL模式）       

# 物理结构
## 目录结构
|             |         |                                         |
| ----------- | ------- | --------------------------------------- |
| audit       |         | 存放审计日志                            |
| bin         |         | 存放 observer binary 文件               |
| etc         |         | 配置文件目录                                |
| etc2        |         | 配置文件额外保存目录（备份作用）        |
| etc3        |         | 配置文件额外保存目录（备份作用）        |
| lib         |         | 包目录                                  |
| log         |         | 运行时日志目录                            |
| run         |         | 运行时进程目录                         |
| store       | clog    | 动态数据写入的事务日志目录              |
|             | slog    | 静态数据写入的事务日志目录              |
|             | sstable | 静态数据目录                                |

# 存储结构
- 分片（tablet）     
  一张表（普通表）或者 每一个分区（分区表中的分区）对应一个用于存储数据的 Tablet（分片）。    
- MemTable     
  内存：存储动态数据（即增量数据）
  数据：行存     
- SSTable      
  一种用于存储键值对数据的磁盘文件格式（一个排序的、不可变的、持久的Key/Value对Map）：存储基线数据，对应磁盘目录（store/sstable）        
  Tablet内的数据划分成多个 SSTable 文件，这些文件按层级划分为：       
  L0 层 SSTable：当 MemTable 达到一定阈值后，数据被写入磁盘，形成 L0 层 SSTable 文件。       
  L1 层 SSTable：当 L0 层的 SSTable 文件数量达到阈值时，OceanBase 会将其合并成 L1 层 SSTable 文件。        
  Major SSTable：在低峰时段，OceanBase 会进行 Major 合并，将多个较小的 SSTable 文件合并为一个更大的 SSTable 文件，从而进一步优化存储和查询性能。    
- 宏块      
  数据库启动时，会将每个 SSTable 文件按照 2MB 定长大小切分为一个个宏块
- 微块     
  每个宏块会继续切分成多个微块    
  微块根据用户指定存储格式存储实际数据：encoding 格式内部数据以行列混合模式存储；flat格式所有数据行平铺存储

## 行存储
存储时按照表的主键顺序来存储数据，无主键表采用分区级自增列作为隐藏主键     
行的所有列都是存储在一起      

## 列存储
每个列的数据存储为一个独立的 SSTable，而所有列的 SSTable 会组合成一个虚拟的 SSTable

## 索引存储
索引表的存储类似于普通的数据表    
索引的行中除了用户指定的索引列之外，还会存储主表的主键列

## 日志流
副本之间的同步依赖日志流（LS、Log Stream）
每个Tablet 都会对应一个确定的日志流，每个日志流对应多个 Tablet     
DML 操作写入 Tablet 的数据所产生的 Redo 日志会持久化在日志流中

# 事务

# 锁
