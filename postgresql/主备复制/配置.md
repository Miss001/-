# 前提
主库和从库环境配置一致   
主：192.168.131.10   
从：192.168.131.11   
# 主库操作
状态：启动

## 主库创建备份账号
```
CREATE USER replica REPLICATION LOGIN CONNECTION LIMIT 10 ENCRYPTED PASSWORD '123456';
```

## 修改主库的 postgresql.conf
vi /opt/postgresql/data/postgresql.conf
```
listen_addresses = '*'   #监听的IP地址
max_connections = 100    #最大连接数，从库的max_connections必须要大于主库的
wal_level = replica      #记录足够的信息以支持常见的备库用途，包括流复制和热备。
synchronous_commit = on  #开启同步复制
max_wal_senders = 10     #同步最大的进程数量
wal_sender_timeout = 60s #流复制主机发送数据的超时时间
```

## 修改主库的 pg_hba.conf
vi /opt/postgresql/data/pg_hba.conf
```
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    replication     replica         0.0.0.0/0               trust
```

# 从库操作
状态：关闭

## 备份主库的数据同步至从库
```
/opt/postgresql/bin/pg_basebackup -h 192.168.131.10  -p 5432  -D /opt/postgresql/data -U replica -Fp  -Xs -P
chown -R postgres:postgres /opt/postgresql/data

#-F p：指定输出格式，这里使用 p 表示 plain 格式，即直接将文件拷贝到目标目录。另一种选择是 t（tar 格式），可以将数据备份为一个 .tar 文件。
#-X s：指定 WAL 日志的处理方式，这里使用 s 表示 stream 模式，在备份过程中会实时同步 WAL 日志。该选项确保在备份完成时数据一致。其他可选值：f（fetch 模式，表示在备份完成后再获取 WAL 日志文件）。
#-P：显示备份进度，启用后会在控制台上输出备份的进度信息。
```

## 配置从库的 postgresql.conf
vi /opt/postgresql/data/postgresql.conf
```
primary_conninfo = 'host=192.168.131.10 port=5432 user=replica password=123456' #对应主库的连接信息
recovery_target_timeline = 'latest' #流复制同步到最新的数据
max_connections = 1000             # 最大连接数，从节点需设置比主节点大
hot_standby = on                   # 开启热备
max_standby_streaming_delay = 30s  # 数据流备份的最大延迟时间
wal_receiver_status_interval = 1s  # 从节点向主节点报告自身状态的最长间隔时间
hot_standby_feedback = on          # 如果有错误的数据复制向主进行反馈
```

## 启动从库
```
sh /opt/postgresql/bin/stop-postgres.sh
```

# 状态验证



