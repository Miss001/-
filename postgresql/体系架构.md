# 基本架构
![image](https://github.com/user-attachments/assets/94eeff51-56ea-4887-95b9-5fd9e0b9b2db)

## 逻辑结构
一个Postgresql服务器运行在一个主机(host)上并且管理着一个database cluster。  
一个DataBase Cluster可以包括：多个Database、多个User、以及Database中的所有对象。
一个Database 可以有多个Schema（数据库中的命名空间），在数据库中创建的所有对象都是在Schema中创建，一个用户可以从同一个客户端连接中访问不同的Schema。不同的Schema中可以有多个同名的表、视图、索引等对象。当创建一个数据库时，会为其创建一个名为public的默认Schema。  
每个Database是相互独立的，彼此之间无法直接进行跨库关联查询，需要借助dblink或其他扩展。  
每个Database都有自己独立的表和索引文件，表和索引文件的大小限制为1 GB。   
每个表都有两个关联文件、后缀分别为 _fsm 和 _vm。它们称为可用空间映射和可见性映射。用于存储有关可用空间容量的信息、并可查看表文件中的每个页面   
索引只具有单个可用空间映射、而不具有可见性映射。   
所有数据库对象都由各自的OID在内部管理，其OID存储在pg_database中。  
表和索引也由各个OID管理，其OID存储在pg_class中。 
```
-- 数据库对应的oid
select * from pg_database ;
-- 表/索引等对应的oid
select * from pg_class  
```
![image](https://github.com/user-attachments/assets/f4840d02-10db-419b-81cc-708b384e5aa6)


## 物理结构
一个database cluster基本上就是作为基础目录(base directory)的一个目录：$PGDATA  
一个database是base子目录下的一个子目录。  
每一个表和索引在base子目录中保存在(至少)一个文件（索引和数据可以保存在一个物理文件中）。  

## 事务
特性：ACID（原子性/一致性/隔离性/持久性）  
默认隔离级别：Read Committed  
**开启事务**  
```
BEGIN TRANSACTION;
BEGIN WORK;
BEGIN;
```
**提交事务**  
```
COMMIT TRANSACTION;
COMMIT WORK;
COMMIT;
```
**回滚事务**  
```
ROLLBACK TRANSACTION;
ROLLBACK WORK;
ROLLBACK;
```
**子事务（保存点）**  
SAVEPOINT（保存点）是一个数据库特性，它允许你在事务中创建命名点，在处理事务中的错误或异常时有选择地回滚到事务中的特定点，而不必撤消到目前为止所做的所有更改。一旦事务结束，保存点的生命周期就结束了，即事务结束后，没有办法回到某个保存点。
示例：
```
CREATE TABLE test0 AS SELECT 1 AS i;
-- Start a main transaction
BEGIN;
-- Perform some operations within the transaction
UPDATE test0 SET i = i + 1;
-- Start a subtransaction
SAVEPOINT s1;
-- Continue with more operations
UPDATE test0 SET i = i - 1000;
-- Check the content in the table
SELECT * FROM test0;
  i
------
 -998
(1 row)
-- Something went wrong, let's roll back to the savepoint
ROLLBACK TO SAVEPOINT s1;
-- Continue with other operations
UPDATE test0 SET i = i + 1;
-- Finally, when everything is fine, commit the transaction
COMMIT;
-- Check the content in the table again
SELECT * FROM test0;
 i
---
 3
(1 row)
```
**组合事务**  


## 锁
### 表级锁
***ACCESS SHARE***  
每次执行 SELECT 查询时，相关的表上自动获取 ACCESS SHARE 锁，以确保数据读取过程中表的结构不发生变化。    
兼容性：ACCESS SHARE 锁之间不会相互阻塞，但它会阻止获取 ACCESS EXCLUSIVE 锁的操作（例如 DROP TABLE、TRUNCATE 或 ALTER TABLE 操作），以避免在读取表时被这些破坏性操作打断。  
***ROW SHARE***  
通常在执行操作如 SELECT ... FOR UPDATE 或 SELECT ... FOR SHARE 时被使用  
***ROW EXCLUSIVE***  
对表执行数据修改操作时（如 INSERT、UPDATE、DELETE），该表自动加上 ROW EXCLUSIVE 锁。它不会阻止其他事务读取表数据或执行其他行级修改操作，但会防止一些表结构变更操作  
***SHARE***  
由CREATE INDEX（不带CONCURRENTLY）获得。  
***SHARE ROW EXCLUSIVE***  
由CREATE TRIGGER和某些形式的 ALTER TABLE所获得
***SHARE UPDATE EXCLUSIVE***  
由VACUUM（不带FULL）、ANALYZE、 CREATE INDEX CONCURRENTLY、REINDEX CONCURRENTLY、 CREATE STATISTICS以及某些ALTER INDEX 和 ALTER TABLE的变体获得
***EXCLUSIVE***  
由REFRESH MATERIALIZED VIEW CONCURRENTLY获得
***ACCESS EXCLUSIVE***  
由ALTER TABLE、DROP TABLE、TRUNCATE、REINDEX、CLUSTER、VACUUM FULL和REFRESH MATERIALIZED VIEW（不带CONCURRENTLY）命令获得。

### 行级锁


## 数据类型
| 名称                                          | 别名                         | 描述                                   |
| --------------------------------------------- | ---------------------------- | -------------------------------------- |
| `smallint`                                    | `int2`                       | 有符号双字节整数                       |
| `integer`                                     | `int`，`int4`                | 有符号四字节整数                       |
| `bigint`                                      | `int8`                       | 有符号的八字节整数                     |
| `smallserial`                                 | `serial2`                    | 自动递增双字节整数                     |
| `bigserial`                                   | `serial8`                    | 自动递增八字节整数                     |
| `serial`                                      | `serial4`                    | 自动递增四字节整数                     |
| `real`                                        | `float4`                     | 单精度浮点数（4字节）                  |
| `double precision`                            | `float8`                     | 双精度浮点数（8 个字节）               |
| `numeric [ (*`p`*, *`s`*) ]`                  | `decimal [ (*`p`*, *`s`*) ]` | 可选精度的精确数字                     |
| `bit [ (*`n`*) ]`                             |                              | 固定长度的位串                         |
| `bit varying [ (*`n`*) ]`                     | `varbit [ (*`n`*) ]`         | 可变长度的位串                         |
| `boolean`                                     | `bool`                       | 逻辑布尔值（真/假）                    |
| `character [ (*`n`*) ]`                       | `char [ (*`n`*) ]`           | 定长字符串                             |
| `character varying [ (*`n`*) ]`               | `varchar [ (*`n`*) ]`        | 可变长度字符串                         |
| `text`                                        |                              | 可变长度字符串                         |
| `date`                                        |                              | 日历日期（年、月、日）                 |
| `time [ (*`p`*) ] [ without time zone ]`      |                              | 一天中的时间（无时区）                 |
| `time [ (*`p`*) ] with time zone`             | `timetz`                     | 一天中的时间，包括时区                 |
| `timestamp [ (*`p`*) ] [ without time zone ]` |                              | 日期和时间（无时区）                   |
| `timestamp [ (*`p`*) ] with time zone`        | `timestamptz`                | 日期和时间，包括时区                   |
| `interval [ *`fields`* ] [ (*`p`*) ]`         |                              | 时间跨度                               |
| `json`                                        |                              | 文本 JSON 数据                         |
| `jsonb`                                       |                              | 二进制 JSON 数据，已分解               |
| `uuid`                                        |                              | 通用唯一标识符                         |
| `bytea`                                       |                              | 二进制数据（“字节数组”）               |
| `xml`                                         |                              | XML 数据                               |
| `tsquery`                                     |                              | 文本搜索查询                           |
| `tsvector`                                    |                              | 文本搜索文档                           |
| `point`                                       |                              | 平面上的几何点                         |
| `polygon`                                     |                              | 平面上的封闭几何路径                   |
| `path`                                        |                              | 平面上的几何路径                       |
| `line`                                        |                              | 平面上的无限长线                       |
| `lseg`                                        |                              | 平面上的线段                           |
| `circle`                                      |                              | 平面上的圆                             |
| `box`                                         |                              | 平面上的矩形框                         |
| `inet`                                        |                              | IPv4 或 IPv6 主机地址                  |
| `macaddr`                                     |                              | MAC（媒体访问控制）地址                |
| `macaddr8`                                    |                              | MAC（媒体访问控制）地址（EUI-64 格式） |
| `cidr`                                        |                              | IPv4 或 IPv6 网络地址                  |
| `money`                                       |                              | 货币金额                               |
| `pg_lsn`                                      |                              | PostgreSQL日志序列号                   |
| `pg_snapshot`                                 |                              | 用户级交易ID快照                       |

## 常用函数
查询内置函数
```
SELECT
    p.proname AS function_name,
    pg_catalog.pg_get_function_result(p.oid) AS return_type
FROM
    pg_proc p
JOIN
    pg_namespace n ON p.pronamespace = n.oid
WHERE
    n.nspname = 'pg_catalog'
ORDER BY
    function_name;
```
### 日期函数
| 名称              | 返回类型         | 功能                                                   | 用法                                                         | 结果                              |
| ----------------- | ---------------- | ------------------------------------------------------ | ------------------------------------------------------------ | --------------------------------- |
| current_date      | date             | 返回当前日期                                           | SELECT current_date                                          |                                   |
| current_time      | timestamptz      | 返回当前时间                                           | SELECT current_time                                          |                                   |
| current_timestamp | timestamptz      | 返回当前日期和时间以及时区                             | SELECT current_timestamp                                     |                                   |
| localtime         | time             | 返回当前事务开始的时间                                 | SELECT localtime                                             |                                   |
| localtimestamp    | timestamptz      | 返回当前事务开始的日期和时间                           | SELECT localtimestamp                                        |                                   |
| now               | timestamptz      | 返回当前事务开始的日期和时间以及时区                   | SELECT now()                                                 |                                   |
| age               | interval         | 计算两个时间戳之间的年龄，并返回使用年和月的“符号”结果 | SELECT age('2024-01-01 00:00:00', '2000-01-01 15:20:10')     | 23 years 11 mons 30 days 08:39:50 |
| date_part         | double precision | 获取时间戳或间隔值的字段，例如年、月、日等。           | SELECT date_part('year', TIMESTAMP '2017-01-01')             | 2017                              |
| date_trunc        | timestamp        | 返回截断为指定精度的时间戳                             | SELECT date_trunc('day', TIMESTAMP '2017-03-17 02:09:30')    | 2017-03-17 00:00:00               |
| extract           | double precision | 与 date_part() 函数相同                                | SELECT extract('YEAR' FROM TIMESTAMP '2017-01-01')           | 2017                              |
| to_date           | date             | 将字符串文字转为日期                                   | SELECT to_date('2024-01-01','YYYY-MM-DD')                    |                                   |
| to_timestamp      | timestamptz      | 将字符串转换为基于指定格式的时间戳                     | SELECT to_timestamp('2024-01-01 22:30:59','YYYY-MM-DD HH24:MI:SS') |                                   |

### 字符串函数
| 名称           | 返回类型     | 功能                                                         | 用法                                                         | 结果                             |
| -------------- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | -------------------------------- |
| length         | integer      | 返回字符串中的字符数                                         | SELECT length('ABC')                                         | 3                                |
| replace        | text         | 将字符串中出现的所有子字符串 from 替换为子字符串 to          | SELECT replace('ABC','A','E')                                | EBC                              |
| translate      | text         | 返回一个字符串，其中一组字符中的字符被另一组字符替换(长度不一致时多余字符会删除) | SELECT translate('12345', '134', 'ax')                       | a2x5                             |
| repeat         | text         | 重复字符串指定的次数                                         | SELECT repeat('*',3)                                         | ***                              |
| lpad           | text         | 在一个字符串左侧填充字符到一定长度                           | SELECT lpad('123', 5, '00')                                  | 00123                            |
| rpad           | text         | 在字符串右侧填充字符到一定长度                               | SELECT rpad('123', 5, '00')                                  | 12300                            |
| ltrim          | text         | 从字符串的开头删除所有字符（默认情况下为空格）               | SELECT ltrim('00120300', '0')                                | 120300                           |
| rtrim          | text         | 从字符串末尾删除所有字符（默认情况下为空格）                 | SELECT rtrim('00120300', '0')                                | 001203                           |
| trim           | text         | 从字符串的左侧、右侧或两侧所有字符（默认情况下为空格）       | SELECT trim('00120300', '0')                                 | 1203                             |
| left           | text         | 返回字符串中的前 n 个字符                                    | SELECT left('ABC',2),left('ABC',-2)                          | AB  A                            |
| right          | text         | 返回字符串中的最后 n 个字符。当 n 为负数时，返回除前abs(n)个之外的所有字符 | SELECT right('ABC',2),right('ABC',-2)                        | BC C                             |
| substring      | text         | 从字符串中提取子字符串                                       | SELECT substring('apple',1,2)                                | ap                               |
| substr         | text         | 从字符串中提取子字符串                                       | SELECT substr('apple',1,2)                                   | ap                               |
| split_part     | text         | 按指定分隔符分割字符串，并返回第 n 个子字符串                | SELECT split_part('A,B,C', ',', 2)                           | B                                |
| position       | integer      | 返回字符串中子字符串的位置                                   | SELECT position('ABC' IN 'ABCDABCDACB')                      | 1                                |
| regexp_matches | SETOF text[] | 将 POSIX 正则表达式与字符串进行匹配，并返回匹配的子字符串    | SELECT regexp_matches('Learning #PostgreSQL #REGEXP_MATCHES','#([A-Za-z0-9_]+)','g') | {PostgreSQL} {REGEXP_MATCHES}    |
| regexp_replace | text         | 将与 POSIX 正则表达式匹配的子字符串替换为新的子字符串        | SELECT regexp_replace('John Doe','(.*) (.*)','\2, \1')       | Doe, John                        |
| lower          | text         | 将字符串转换为小写                                           | SELECT lower('appLE')                                        | apple                            |
| upper          | text         | 将字符串转换为大写                                           | SELECT upper('appLE')                                        | APPLE                            |
| initcap        | text         | 将字符串中的单词转换为标题式大小写                           | SELECT initcap('appLE')                                      | Apple                            |
| format         | text         | 基于格式字符串格式化参数                                     | SELECT format('%s, %s, %2$s, %1$s', 'A', 'B')                | A, C, C, A                       |
| \|\|           |              | 将两个或多个字符串连接成一个                                 | SELECT 'A'\|\|NULL\|\|'C'                                    | NULL                             |
| concat         | text         | 将两个或多个字符串连接成一个                                 | SELECT concat('A',NULL,'C')                                  | AC                               |
| concat_ws      | text         | 将多个字符串连接成一个由指定分隔符分隔的字符串               | SELECT concat_ws(',','A',NULL,'C')                           | A,C                              |
| to_char        | text         | 将时间戳、间隔、整数、双精度或数值转换为字符串               | SELECT to_char(387,'999999')<br/>SELECT to_char(TIMESTAMP '2024-01-01 22:30:59','YYYY-MM-DD HH24:MI:SS') |                                  |
| to_number      | numeric      | 将字符串转换为数值                                           | SELECT to_number('-12,345.6', '9999999.9')                   |                                  |
| reverse        | text         | 返回反转的字符串                                             | SELECT reverse('ABC')                                        | CBA                              |
| md5            | text         | 以十六进制形式返回字符串的 MD5 哈希值                        | SELECT md5('ABC')                                            | 902fbdd2b1df0c4f70b4a5d23525e932 |

## 自定义函数
创建语法
```
create [or replace] function function_name(param_list)
   returns return_type 
   language plpgsql
  as
$$
declare 
-- variable declaration
begin
 -- logic
end;
$$
```
## 存储过程
创建语法
```
create [or replace] procedure procedure_name(parameter_list)
language plpgsql
as $$
declare
-- variable declaration
begin
-- stored procedure body
end; $$
```
