## 数据类型
| 名称                                          | 别名                         | 描述                                   |
| --------------------------------------------- | ---------------------------- | -------------------------------------- |
| `smallint`                                    | `int2`                       | 有符号双字节整数                       |
| `integer`                                     | `int`，`int4`                | 有符号四字节整数                       |
| `bigint`                                      | `int8`                       | 有符号的八字节整数                     |
| `smallserial`                                 | `serial2`                    | 自动递增双字节整数                     |
| `bigserial`                                   | `serial8`                    | 自动递增八字节整数                     |
| `serial`                                      | `serial4`                    | 自动递增四字节整数                     |
| `real`                                        | `float4`                     | 单精度浮点数（4字节）                  |
| `double precision`                            | `float8`                     | 双精度浮点数（8 个字节）               |
| `numeric [ (*`p`*, *`s`*) ]`                  | `decimal [ (*`p`*, *`s`*) ]` | 可选精度的精确数字                     |
| `bit [ (*`n`*) ]`                             |                              | 固定长度的位串                         |
| `bit varying [ (*`n`*) ]`                     | `varbit [ (*`n`*) ]`         | 可变长度的位串                         |
| `boolean`                                     | `bool`                       | 逻辑布尔值（真/假）                    |
| `character [ (*`n`*) ]`                       | `char [ (*`n`*) ]`           | 定长字符串                             |
| `character varying [ (*`n`*) ]`               | `varchar [ (*`n`*) ]`        | 可变长度字符串                         |
| `text`                                        |                              | 可变长度字符串                         |
| `date`                                        |                              | 日历日期（年、月、日）                 |
| `time [ (*`p`*) ] [ without time zone ]`      |                              | 一天中的时间（无时区）                 |
| `time [ (*`p`*) ] with time zone`             | `timetz`                     | 一天中的时间，包括时区                 |
| `timestamp [ (*`p`*) ] [ without time zone ]` |                              | 日期和时间（无时区）                   |
| `timestamp [ (*`p`*) ] with time zone`        | `timestamptz`                | 日期和时间，包括时区                   |
| `interval [ *`fields`* ] [ (*`p`*) ]`         |                              | 时间跨度                               |
| `json`                                        |                              | 文本 JSON 数据                         |
| `jsonb`                                       |                              | 二进制 JSON 数据，已分解               |
| `uuid`                                        |                              | 通用唯一标识符                         |
| `bytea`                                       |                              | 二进制数据（“字节数组”）               |
| `xml`                                         |                              | XML 数据                               |
| `tsquery`                                     |                              | 文本搜索查询                           |
| `tsvector`                                    |                              | 文本搜索文档                           |
| `point`                                       |                              | 平面上的几何点                         |
| `polygon`                                     |                              | 平面上的封闭几何路径                   |
| `path`                                        |                              | 平面上的几何路径                       |
| `line`                                        |                              | 平面上的无限长线                       |
| `lseg`                                        |                              | 平面上的线段                           |
| `circle`                                      |                              | 平面上的圆                             |
| `box`                                         |                              | 平面上的矩形框                         |
| `inet`                                        |                              | IPv4 或 IPv6 主机地址                  |
| `macaddr`                                     |                              | MAC（媒体访问控制）地址                |
| `macaddr8`                                    |                              | MAC（媒体访问控制）地址（EUI-64 格式） |
| `cidr`                                        |                              | IPv4 或 IPv6 网络地址                  |
| `money`                                       |                              | 货币金额                               |
| `pg_lsn`                                      |                              | PostgreSQL日志序列号                   |
| `pg_snapshot`                                 |                              | 用户级交易ID快照                       |

## 常用函数
查询内置函数
```
SELECT
    p.proname AS function_name,
    pg_catalog.pg_get_function_result(p.oid) AS return_type
FROM
    pg_proc p
JOIN
    pg_namespace n ON p.pronamespace = n.oid
WHERE
    n.nspname = 'pg_catalog'
ORDER BY
    function_name;
```
### 日期函数
| 名称              | 返回类型         | 功能                                                   | 用法                                                         | 结果                              |
| ----------------- | ---------------- | ------------------------------------------------------ | ------------------------------------------------------------ | --------------------------------- |
| current_date      | date             | 返回当前日期                                           | SELECT current_date                                          |                                   |
| current_time      | timestamptz      | 返回当前时间                                           | SELECT current_time                                          |                                   |
| current_timestamp | timestamptz      | 返回当前日期和时间以及时区                             | SELECT current_timestamp                                     |                                   |
| localtime         | time             | 返回当前事务开始的时间                                 | SELECT localtime                                             |                                   |
| localtimestamp    | timestamptz      | 返回当前事务开始的日期和时间                           | SELECT localtimestamp                                        |                                   |
| now               | timestamptz      | 返回当前事务开始的日期和时间以及时区                   | SELECT now()                                                 |                                   |
| age               | interval         | 计算两个时间戳之间的年龄，并返回使用年和月的“符号”结果 | SELECT age('2024-01-01 00:00:00', '2000-01-01 15:20:10')     | 23 years 11 mons 30 days 08:39:50 |
| date_part         | double precision | 获取时间戳或间隔值的字段，例如年、月、日等。           | SELECT date_part('year', TIMESTAMP '2017-01-01')             | 2017                              |
| date_trunc        | timestamp        | 返回截断为指定精度的时间戳                             | SELECT date_trunc('day', TIMESTAMP '2017-03-17 02:09:30')    | 2017-03-17 00:00:00               |
| extract           | double precision | 与 date_part() 函数相同                                | SELECT extract('YEAR' FROM TIMESTAMP '2017-01-01')           | 2017                              |
| to_date           | date             | 将字符串文字转为日期                                   | SELECT to_date('2024-01-01','YYYY-MM-DD')                    |                                   |
| to_timestamp      | timestamptz      | 将字符串转换为基于指定格式的时间戳                     | SELECT to_timestamp('2024-01-01 22:30:59','YYYY-MM-DD HH24:MI:SS') |                                   |

### 字符串函数
| 名称           | 返回类型     | 功能                                                         | 用法                                                         | 结果                             |
| -------------- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | -------------------------------- |
| length         | integer      | 返回字符串中的字符数                                         | SELECT length('ABC')                                         | 3                                |
| replace        | text         | 将字符串中出现的所有子字符串 from 替换为子字符串 to          | SELECT replace('ABC','A','E')                                | EBC                              |
| translate      | text         | 返回一个字符串，其中一组字符中的字符被另一组字符替换(长度不一致时多余字符会删除) | SELECT translate('12345', '134', 'ax')                       | a2x5                             |
| repeat         | text         | 重复字符串指定的次数                                         | SELECT repeat('*',3)                                         | ***                              |
| lpad           | text         | 在一个字符串左侧填充字符到一定长度                           | SELECT lpad('123', 5, '00')                                  | 00123                            |
| rpad           | text         | 在字符串右侧填充字符到一定长度                               | SELECT rpad('123', 5, '00')                                  | 12300                            |
| ltrim          | text         | 从字符串的开头删除所有字符（默认情况下为空格）               | SELECT ltrim('00120300', '0')                                | 120300                           |
| rtrim          | text         | 从字符串末尾删除所有字符（默认情况下为空格）                 | SELECT rtrim('00120300', '0')                                | 001203                           |
| trim           | text         | 从字符串的左侧、右侧或两侧所有字符（默认情况下为空格）       | SELECT trim('00120300', '0')                                 | 1203                             |
| left           | text         | 返回字符串中的前 n 个字符                                    | SELECT left('ABC',2),left('ABC',-2)                          | AB  A                            |
| right          | text         | 返回字符串中的最后 n 个字符。当 n 为负数时，返回除前abs(n)个之外的所有字符 | SELECT right('ABC',2),right('ABC',-2)                        | BC C                             |
| substring      | text         | 从字符串中提取子字符串                                       | SELECT substring('apple',1,2)                                | ap                               |
| substr         | text         | 从字符串中提取子字符串                                       | SELECT substr('apple',1,2)                                   | ap                               |
| split_part     | text         | 按指定分隔符分割字符串，并返回第 n 个子字符串                | SELECT split_part('A,B,C', ',', 2)                           | B                                |
| position       | integer      | 返回字符串中子字符串的位置                                   | SELECT position('ABC' IN 'ABCDABCDACB')                      | 1                                |
| regexp_matches | SETOF text[] | 将 POSIX 正则表达式与字符串进行匹配，并返回匹配的子字符串    | SELECT regexp_matches('Learning #PostgreSQL #REGEXP_MATCHES','#([A-Za-z0-9_]+)','g') | {PostgreSQL} {REGEXP_MATCHES}    |
| regexp_replace | text         | 将与 POSIX 正则表达式匹配的子字符串替换为新的子字符串        | SELECT regexp_replace('John Doe','(.*) (.*)','\2, \1')       | Doe, John                        |
| lower          | text         | 将字符串转换为小写                                           | SELECT lower('appLE')                                        | apple                            |
| upper          | text         | 将字符串转换为大写                                           | SELECT upper('appLE')                                        | APPLE                            |
| initcap        | text         | 将字符串中的单词转换为标题式大小写                           | SELECT initcap('appLE')                                      | Apple                            |
| format         | text         | 基于格式字符串格式化参数                                     | SELECT format('%s, %s, %2$s, %1$s', 'A', 'B')                | A, C, C, A                       |
| \|\|           |              | 将两个或多个字符串连接成一个                                 | SELECT 'A'\|\|NULL\|\|'C'                                    | NULL                             |
| concat         | text         | 将两个或多个字符串连接成一个                                 | SELECT concat('A',NULL,'C')                                  | AC                               |
| concat_ws      | text         | 将多个字符串连接成一个由指定分隔符分隔的字符串               | SELECT concat_ws(',','A',NULL,'C')                           | A,C                              |
| to_char        | text         | 将时间戳、间隔、整数、双精度或数值转换为字符串               | SELECT to_char(387,'999999')<br/>SELECT to_char(TIMESTAMP '2024-01-01 22:30:59','YYYY-MM-DD HH24:MI:SS') |                                  |
| to_number      | numeric      | 将字符串转换为数值                                           | SELECT to_number('-12,345.6', '9999999.9')                   |                                  |
| reverse        | text         | 返回反转的字符串                                             | SELECT reverse('ABC')                                        | CBA                              |
| md5            | text         | 以十六进制形式返回字符串的 MD5 哈希值                        | SELECT md5('ABC')                                            | 902fbdd2b1df0c4f70b4a5d23525e932 |

## 主键设置
### 1.使用 SERIAL/BIGSERIAL 数据类型 自增主键
本质是基于一个序列（sequence）来生成唯一的递增值，PostgreSQL 在执行 INSERT 语句时，会在插入数据之前生成并分配该序列的下一个值。
当插入操作失败时，例如由于违反约束（如唯一约束或其他业务逻辑错误），序列的值已被消费，但数据未被插入，这就会导致序列跳过了一个值。
```
CREATE TABLE tmp1 (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    createdtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
### 2.使用 IDENTITY 列 自增主键
当列被定义为 GENERATED ALWAYS 时，数据库始终自动为该列生成递增的值。即使用户在插入语句中为该列提供了值，也会被忽略，数据库将用自动生成的值替代用户提供的值。  
当列被定义为 GENERATED BY DEFAULT 表示当用户没有为该列提供值时，数据库将自动生成递增的值。如果用户提供了值，数据库将使用用户提供的值而不是自动生成的值。  
```
CREATE TABLE tmp1 (
    user_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    createdtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
### 3.使用 自定义序列 自增主键
```
创建序列
CREATE SEQUENCE user_id_seq;
ALTER SEQUENCE user_id_seq INCREMENT BY 1;
创建表
CREATE TABLE tmp1 (
    user_id INT DEFAULT nextval('user_id_seq') PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    createdtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## uuid 主键
```
CREATE TABLE tmp1 (
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    createdtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
## 语句块
```
do $$ 
declare
  cur_ CURSOR FOR select user_id from tmp1;
  v_sql text;
begin
   for i in cur_ LOOP
    begin
     /*
       insert into tmp2
          select user_id from tmp1 where user_id=i.user_id;
      */
      v_sql :='insert into tmp2 select user_id from tmp1 where user_id='''||i.user_id||'''';
      EXECUTE v_sql;
    
      EXCEPTION 
     WHEN others THEN
       RAISE NOTICE 'Error occurred: SQLSTATE: %, Message: %', SQLSTATE, SQLERRM;

    end;
    END LOOP;

end $$;
```
## 自定义函数创建
```
create or replace function get_name(v_id uuid)
returns varchar
language plpgsql
as
$$
declare
  v_sql text;
  res varchar(100);
begin
     select username into res from tmp1 where user_id=v_id;
       -- 成功时返回结果
     return res;
     
    EXCEPTION
    WHEN OTHERS THEN
       RAISE NOTICE 'Error occurred: SQLSTATE: %, Message: %', SQLSTATE, SQLERRM;
        return NULL;

end $$;
```

## 存储过程创建
存储过程的子事务不能直接提交
```
CREATE OR REPLACE PROCEDURE p_template()
LANGUAGE plpgsql
AS $$
/*
create table tj_log(
id varchar(36),
task_name varchar(30),
task_desc text,
begin_time timestamp,
end_time timestamp,
bz text
)
*/
DECLARE
  v_id varchar(36);
  v_err text;
  cur_ CURSOR FOR select user_id from tmp1;
    
BEGIN
  v_id :=uuid_generate_v4();
  
  insert into tj_log(id,task_name,task_desc,begin_time,end_time)
    values(v_id,'p_template','存储过程测试',CURRENT_TIMESTAMP,null);

-- ----------------------------------------logic-----------------------------------------------
for i in cur_ LOOP
     insert into tmp2
        select user_id from tmp1 where user_id=i.user_id;
END LOOP;

-- --------------------------------------------------------------------------------------------
UPDATE tj_log SET end_time=CURRENT_TIMESTAMP,bz='完成' WHERE task_name='p_template' AND id=v_id;

EXCEPTION
    -- 捕获其他类型的错误并记录日志
    WHEN others THEN
        v_err :=SQLSTATE ||'-'||SQLERRM;
        UPDATE tj_log SET end_time=CURRENT_TIMESTAMP,bz=v_err WHERE task_name='p_template' AND id=v_id;
        RAISE NOTICE 'Error occurred: SQLSTATE: %, Message: %', SQLSTATE, SQLERRM;
COMMIT;

END;
$$;

```
