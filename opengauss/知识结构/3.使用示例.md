## 主键设置
- 1.使用 SERIAL/BIGSERIAL 数据类型 自增主键  
```
CREATE TABLE tmp1 (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    createdtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
- 2.使用 自定义序列 自增主键  
``` 
创建序列
CREATE SEQUENCE user_id_seq;
ALTER SEQUENCE user_id_seq INCREMENT BY 1;
创建表
CREATE TABLE tmp1 (
    user_id INT DEFAULT nextval('user_id_seq') PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    createdtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
- 3.uuid 主键  
  无生成uuid的函数
```
CREATE TABLE tmp1 (
    user_id UUID PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    createdtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
## 匿名块创建
```
DECLARE
  CURSOR cur_ IS SELECT user_id FROM tmp1;
  v_sql text;
BEGIN
   for i in cur_ LOOP
    BEGIN
     /*
       insert into tmp2
          select user_id from tmp1 where user_id=i.user_id;
      */
      v_sql :='insert into tmp2 select user_id from tmp1 where user_id='''||i.user_id||'''';
      EXECUTE v_sql;
    
      EXCEPTION 
     WHEN others THEN
       RAISE NOTICE 'Error occurred: SQLSTATE: %, Message: %', SQLSTATE, SQLERRM;
    END;
    END LOOP;
END;
```
## 自定义函数创建
兼容plpgsql 创建语法
```
CREATE OR REPLACE FUNCTION get_name(v_id uuid)
RETURN varchar
AS
DECLARE
  v_sql text;
  res varchar(100);
BEGIN
     select username into res from tmp1 where user_id=v_id;
       -- 成功时返回结果
     return res;
     
    EXCEPTION
    WHEN OTHERS THEN
       RAISE NOTICE 'Error occurred: SQLSTATE: %, Message: %', SQLSTATE, SQLERRM;
        return NULL;
END;
```
## 存储过程创建
```
CREATE OR REPLACE PROCEDURE p_template()
AS
/*
create table tj_log(
id varchar(36),
task_name varchar(30),
task_desc text,
begin_time timestamp,
end_time timestamp,
bz text
)
*/
DECLARE
  v_id uuid;
  v_err text;
  CURSOR cur_ IS SELECT user_id FROM tmp1;
BEGIN
  v_id :=uuid_generate_v4();
  
  INSERT INTO tj_log(id,task_name,task_desc,begin_time,end_time,bz)
  VALUES(v_id,'p_template','存储过程测试',sysdate,null,null);
  commit;
-- -- ----------------------------------------logic-----------------------------------------------
  for i in cur_ LOOP
      BEGIN
       insert into tmp2
          select * from tmp1 where user_id=i.user_id;
       END;  
  END LOOP;
  commit;
-- --------------------------------------------------------------------------------------------
   UPDATE tj_log  SET end_time=sysdate, bz='完成' where id=v_id and task_name='p_template';
   commit;
EXCEPTION
    WHEN OTHERS THEN        
        v_err := format('Error occurred: SQLSTATE: %s, Message: %s', SQLSTATE, SQLERRM);
        
        update tj_log set end_time=sysdate, bz=v_err where id=v_id and task_name='p_template';
        commit;
        
        -- RAISE NOTICE 'Error occurred: SQLSTATE: %, Message: %', SQLSTATE, SQLERRM;    
END;
```
## 视图创建
更新视图时，不支持删除视图中的现有列和修改列的排列顺序，只允许在现有列的末尾添加附加列。   
需要修改列的顺序、删除列等，需要先 drop view view_name 后再创建。  
```
CREATE OR REPLACE VIEW v_tmp1 
AS
select user_id, username,price ,createdtime from tmp1
```
